# 修复验证与快速测试指南

> 智能食物记录 App - 快速启动与验证文档

**文档版本：** v1.1
**最后更新：** 2026-01-16

---

## 📋 修复摘要

本次版本解决了两个关键问题：

### 问题一：前端空白页面（已修复 ✅）

**现象：** 访问 `http://localhost:5173/` 显示空白页面

**原因：** 路由守卫调用后端API检查目标状态时，由于没有超时机制，当后端未运行时请求会无限期挂起。

**修复方案：**
- 为所有API调用添加5秒超时机制
- 路由守卫添加3秒快速超时
- API失败时自动降级到localStorage数据
- 向用户显示友好的错误提示

### 问题二：启动脚本可靠性（已修复 ✅）

**现象：** `start_local.bat` 在Python依赖安装步骤失败

**原因：** 脚本每次都尝试安装依赖，未验证是否已安装，缺少降级方案。

**修复方案：**
- 智能依赖检查（通过import验证）
- 跳过已存在的数据库初始化
- 端口占用检测和提示
- 创建简化版备用脚本 `start_quick.bat`

---

## 🚀 快速启动命令

### 方式一：一键启动（推荐）

**适用场景：** 首次启动或完整重启

```bash
start_local.bat
```

**特点：**
- 自动检查并安装依赖
- 初始化数据库（如不存在）
- 启动后端（端口8000）和前端（端口5173）
- 自动打开浏览器

**预计耗时：** 首次 3-5 分钟（含依赖安装），后续 10-20 秒

### 方式二：快速启动

**适用场景：** 后端依赖已安装，仅启动服务

```bash
start_quick.bat
```

**特点：**
- 跳过大部分检查
- 最小化依赖安装
- 快速启动服务

**预计耗时：** 5-10 秒

### 方式三：手动启动（开发者模式）

**适用场景：** 开发调试或需要查看详细日志

**启动后端：**
```bash
cd backend
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**启动前端（新窗口）：**
```bash
cd frontend
npm run dev -- --host 0.0.0.0
```

---

## ✅ 核心流程验证清单（5分钟快速测试）

使用此清单在5分钟内快速验证应用是否已就绪。

### 阶段1：服务启动验证（1分钟）

- [ ] **后端服务启动**
  - 运行 `start_local.bat`
  - 检查是否显示 "Backend starting in new window"
  - 等待10-15秒让服务完全启动

- [ ] **后端API文档可访问**
  - 访问：http://localhost:8000/docs
  - 应显示Swagger API文档界面
  - 能看到 `/goals`、`/balance` 等端点

- [ ] **前端服务启动**
  - 检查是否显示 "Frontend starting in new window"
  - 浏览器应自动打开 `http://localhost:5173`

### 阶段2：首次访问流程验证（2分钟）

> **前置条件：** 清除浏览器localStorage
> ```javascript
> localStorage.clear(); location.reload()
> ```

- [ ] **强制跳转到目标设置页**
  - 访问 `http://localhost:5173/`
  - 应自动跳转到 `/goal`
  - 显示警告提示："⚠️ 请先设置您的减脂目标"

- [ ] **进度指示器显示**
  - 顶部显示步骤1（基本信息）激活
  - 填写基本信息后，步骤2（热量目标）激活

- [ ] **表单数据持久化测试**
  - 填写部分表单（如性别、年龄）
  - **刷新浏览器页面**
  - 验证：数据应保持不变

- [ ] **目标设置成功流程**
  - 完成表单填写
  - 点击"确认并保存"
  - 显示 "✅ 目标设置成功！"
  - 显示倒计时 "3秒后跳转到首页..."
  - 3秒后自动跳转到首页

### 阶段3：首页功能验证（1分钟）

- [ ] **今日余额显示正确**
  - 显示 "📊 今日余额" 卡片
  - 剩余热量和蛋白质有具体数值
  - 进度条显示已用/目标比例

- [ ] **智能建议显示**
  - 显示 "🧠 可以吃这些：" 卡片
  - 列出1-5个推荐食物
  - 显示热量和推荐理由

- [ ] **"立刻记录"按钮可用**
  - 显示 "📷 立刻记录" 按钮（蓝绿渐变）
  - 点击后跳转到拍照/记录页面

- [ ] **今日记录状态**
  - 显示 "📅 今日 ✔✔"（根据记录数）
  - 或显示 "暂无记录"

### 阶段4：记录流程验证（1分钟）

- [ ] **拍照/上传页面**
  - 点击"立刻记录"
  - 显示相机或上传按钮

- [ ] **AI识别与份量选择**
  - 上传食物图片
  - 显示识别的食物名称
  - **关键验证：** 份量选项包含视觉描述
    - 例如："水煮蛋1个（约50g）"
    - 例如："掌心大小（正常厚度，约120g）"
    - 例如："拳头大小（正常，约150g）"

- [ ] **记录确认与余额更新**
  - 选择一个份量选项
  - 点击"确认记录"
  - 返回首页，检查余额是否已扣减
  - 今日记录计数增加（✔数量+1）

---

## 🔧 故障排除

### 问题1：启动脚本失败

**症状：** `start_local.bat` 运行后退出

**解决方案：**

1. **检查Python是否安装**
   ```bash
   python --version
   ```
   应显示 Python 3.8+ 版本

2. **检查Node.js是否安装**
   ```bash
   node --version
   ```
   应显示 Node.js 16+ 版本

3. **手动安装后端依赖**
   ```bash
   cd backend
   python -m pip install -r requirements.txt
   ```

4. **手动安装前端依赖**
   ```bash
   cd frontend
   npm install
   ```

### 问题2：后端无法启动

**症状：** 访问 http://localhost:8000/docs 无法打开

**解决方案：**

1. **检查端口是否被占用**
   ```bash
   netstat -ano | findstr ":8000"
   ```

2. **关闭占用端口的进程**
   - Windows任务管理器 → 查找进程 → 结束python.exe进程

3. **手动启动后端**
   ```bash
   cd backend
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

### 问题3：前端显示错误提示

**症状：** 首页显示 "⚠️ 无法连接到服务器"

**解决方案：**

1. **确认后端已启动**
   - 访问 http://localhost:8000/docs
   - 应显示API文档

2. **检查后端控制台**
   - 查看 "SmartFood-Backend" 窗口
   - 确认无错误信息

3. **等待后端完全启动**
   - 后端启动可能需要10-15秒
   - 等待后刷新前端页面

### 问题4：目标设置后不跳转

**症状：** 设置目标后停留在目标页

**解决方案：**

1. **检查浏览器控制台**
   - 按F12打开开发者工具
   - 查看是否有JavaScript错误

2. **清除localStorage重试**
   ```javascript
   localStorage.clear()
   location.reload()
   ```

3. **手动访问首页**
   - 直接访问 `http://localhost:5173/`
   - 检查是否正常显示

---

## ⚠️ 已知限制

### 1. GLM_API_KEY 配置

**状态：** 需要手动配置

**说明：** AI图片识别功能需要智谱API密钥

**配置步骤：**
1. 打开 `backend/.env` 文件
2. 将 `your_glm_api_key_here` 替换为实际API密钥
   ```
   GLM_API_KEY=你的实际密钥
   ```
3. 重启后端服务

**获取API密钥：** 访问 https://open.bigmodel.cn/

### 2. 手机访问IP配置

**状态：** 自动生成，但可能需要手动选择

**说明：** 如果电脑有多个网络接口，可能显示多个IP地址

**操作：**
- 查看首页"手机访问"卡片
- 如果显示多个IP，点击选择可用的IP
- 确保手机和电脑在同一WiFi

### 3. 浏览器兼容性

**状态：** 推荐使用现代浏览器

**支持情况：**
- ✅ Chrome/Edge（推荐）
- ✅ Firefox
- ✅ Safari（iOS）
- ⚠️ IE11（不支持）

---

## 📱 手机访问快速测试

1. **运行 `start_local.bat`**
2. **查看首页"手机访问"卡片**
3. **复制显示的IP地址** `http://xxx.xxx.xxx.xxx:5173`
4. **手机连接同一WiFi**
5. **在手机浏览器输入地址**
6. **应正常显示应用**

**手机无法连接？**
- 点击 "🔍 手机无法连接？" 查看故障排除指引
- 确保防火墙允许5173端口
- Windows: 控制面板 → Windows防火墙 → 允许应用通过防火墙

---

## 🧪 完整端到端测试（可选）

如需进行更全面的测试，请使用：
- **`MOBILE_TEST_PLAN_TEMPLATE.md`** - 详细的手机端测试计划
- **`MOBILE_VALIDATION_REPORT.md`** - 验证测试报告模板（需手动执行后填写）

---

## 📞 支持与反馈

如遇到本文档未覆盖的问题：

1. 查看 `CRITICAL_FIXES_SUMMARY.md` 了解已修复问题的详细信息
2. 检查浏览器控制台错误信息
3. 查看后端/前端窗口的日志输出

---

*最后更新：2026-01-16*
*相关文档：*
- `CRITICAL_FIXES_SUMMARY.md` - 关键问题修复记录
- `STARTUP_MOBILE_OPTIMIZATION_SUMMARY.md` - 启动流程优化摘要
- `MOBILE_TEST_PLAN_TEMPLATE.md` - 手机端测试计划模板
