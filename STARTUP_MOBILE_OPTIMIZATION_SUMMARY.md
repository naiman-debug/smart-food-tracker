# å¯åŠ¨æµç¨‹å’Œæ‰‹æœºè®¿é—®ä½“éªŒä¼˜åŒ–æ‘˜è¦

> æ™ºèƒ½é£Ÿç‰©è®°å½• App - å¯åŠ¨æµç¨‹ä¸Žæ‰‹æœºè®¿é—®ä½“éªŒä¼˜åŒ–

---

## æ”¹è¿›ç‚¹ï¼šæ‰‹æœºIPèŽ·å–å¯é æ€§æ–¹æ¡ˆ

### 1. åŽç«¯APIæŽ¥å£

**æ–‡ä»¶è·¯å¾„ï¼š** `backend/app/api/system.py` (æ–°å¢ž)

**åŠŸèƒ½è¯´æ˜Žï¼š**
- åˆ›å»º `/api/system/local-ip` ç«¯ç‚¹
- å¤šæ–¹å¼èŽ·å–æœ¬æœºIPï¼šsocketè¿žæŽ¥ã€ipconfig/ifconfigè§£æž
- è¿”å›žä¸»è¦IPã€IPåˆ—è¡¨ã€ä¸»æœºåç­‰ä¿¡æ¯

**å…³é”®ä»£ç ï¼š**

```python
@router.get("/local-ip")
async def get_local_ip():
    """èŽ·å–æœåŠ¡å™¨çš„æœ¬æœºIPåœ°å€åˆ—è¡¨"""
    ip_list = get_local_ip_addresses()
    hostname = socket.gethostname()

    return {
        "ips": ip_list,
        "primary_ip": ip_list[0] if ip_list else "localhost",
        "hostname": hostname,
        "count": len(ip_list)
    }
```

### 2. å¯åŠ¨è„šæœ¬IPé…ç½®ç”Ÿæˆ

**æ–‡ä»¶è·¯å¾„ï¼š** `backend/get_local_ip.py` (æ–°å¢ž)

**åŠŸèƒ½è¯´æ˜Žï¼š**
- Pythonè„šæœ¬èŽ·å–æœ¬æœºIPå¹¶å†™å…¥ `frontend/public/ip-config.json`
- åœ¨å¯åŠ¨æœåŠ¡å‰è‡ªåŠ¨æ‰§è¡Œ
- ä½œä¸ºAPIçš„åŽå¤‡æ–¹æ¡ˆ

**ç”Ÿæˆçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼š**

```json
{
  "ips": ["192.168.1.100", "192.168.0.5"],
  "primary_ip": "192.168.1.100",
  "hostname": "DESKTOP-ABC123",
  "port": 5173,
  "timestamp": 1737004800
}
```

### 3. å‰ç«¯å¤šå±‚çº§IPèŽ·å–ç­–ç•¥

**æ–‡ä»¶è·¯å¾„ï¼š** `frontend/src/views/Home.vue`

**èŽ·å–ç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š**

1. **åŽç«¯API**ï¼ˆæœ€å¯é ï¼‰- `api.getLocalIp()`
2. **é™æ€é…ç½®æ–‡ä»¶**ï¼ˆåŽå¤‡ï¼‰- `api.getIpFromConfig()`
3. **WebRTC**ï¼ˆå®¢æˆ·ç«¯æ£€æµ‹ï¼‰- åŽŸæœ‰æ–¹æ³•ä¿ç•™
4. **window.location**ï¼ˆæœ€ç»ˆåŽå¤‡ï¼‰- `localhost`

**å…³é”®ä»£ç ï¼š**

```typescript
async function getLocalIP() {
  // Tier 1: Try backend API
  const backendIp = await api.getLocalIp()
  if (backendIp?.primary_ip) {
    localIP.value = backendIp.primary_ip
    multipleIPs.value = backendIp.ips
    return
  }

  // Tier 2: Try static config file
  const configIp = await api.getIpFromConfig()
  if (configIp?.primary_ip) {
    localIP.value = configIp.primary_ip
    multipleIPs.value = configIp.ips
    return
  }

  // Tier 3: WebRTC fallback
  // Tier 4: window.location fallback
}
```

---

## ä¼˜åŒ–å†…å®¹ï¼šç›®æ ‡è®¾ç½®æµç¨‹ä½“éªŒå¢žå¼º

### 1. è¿›åº¦æŒ‡ç¤ºå™¨

**æ–‡ä»¶è·¯å¾„ï¼š** `frontend/src/views/Goal.vue`

**æ–°å¢žUIç»„ä»¶ï¼š**
- ä¸¤æ­¥è¿›åº¦æ˜¾ç¤ºï¼šæ­¥éª¤1/2 åŸºæœ¬ä¿¡æ¯ â†’ æ­¥éª¤2/2 çƒ­é‡ç›®æ ‡
- åœ†å½¢æ­¥éª¤å›¾æ ‡ï¼Œå¸¦æ¿€æ´»/å®ŒæˆçŠ¶æ€
- è¿›åº¦è¿žæŽ¥çº¿ï¼Œå®Œæˆæ—¶å˜ç»¿

**æ•ˆæžœï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â‘         â”€â”€â”€â”€        â‘¡       â”‚
â”‚ åŸºæœ¬ä¿¡æ¯           çƒ­é‡ç›®æ ‡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è¡¨å•æ•°æ®æŒä¹…åŒ–

**localStorage keyï¼š** `smartfood_goal_form_draft`

**åŠŸèƒ½è¯´æ˜Žï¼š**
- ç”¨æˆ·å¡«å†™è¡¨å•æ—¶è‡ªåŠ¨ä¿å­˜åˆ°localStorage
- é¡µé¢åˆ·æ–°åŽè‡ªåŠ¨æ¢å¤å·²å¡«å†™æ•°æ®
- ä¿å­˜æˆåŠŸåŽæ¸…é™¤è‰ç¨¿æ•°æ®

**å…³é”®ä»£ç ï¼š**

```typescript
// Load from storage on mount
const formData = ref(loadFormDataFromStorage())

// Watch and auto-save
watch(formData, (newData) => {
  localStorage.setItem(GOAL_FORM_KEY, JSON.stringify(newData))

  // Update progress step
  if (newData.gender && newData.age && newData.height_cm && newData.weight_kg) {
    currentStep.value = 2
  } else {
    currentStep.value = 1
  }
}, { deep: true })
```

### 3. æˆåŠŸæç¤ºä¸Žè‡ªåŠ¨è·³è½¬

**æ–°å¢žUIç»„ä»¶ï¼š**
- ç»¿è‰²æ¸å˜æˆåŠŸæ¶ˆæ¯å¡ç‰‡
- 3ç§’å€’è®¡æ—¶æ˜¾ç¤º
- è‡ªåŠ¨è·³è½¬åˆ°ç›®æ ‡é¡µé¢

**æ•ˆæžœï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ…  ç›®æ ‡è®¾ç½®æˆåŠŸï¼               â”‚
â”‚    3ç§’åŽè·³è½¬åˆ°é¦–é¡µ...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç ï¼š**

```typescript
// Show success and countdown
showSuccessMessage.value = true
const countdownInterval = setInterval(() => {
  countdown.value--
  if (countdown.value <= 0) {
    clearInterval(countdownInterval)
    performRedirect()
  }
}, 1000)
```

### 4. è·³è¿‡è®¾ç½®é€‰é¡¹

**æ–°å¢žåŠŸèƒ½ï¼š**
- "è·³è¿‡ï¼Œç¨åŽè®¾ç½®"æŒ‰é’®
- è®¾ç½® `localStorage` æ ‡è®° `smartfood_goal_skipped`
- å…è®¸ç”¨æˆ·å…ˆæµè§ˆåº”ç”¨ï¼Œç¨åŽè®¾ç½®ç›®æ ‡

**è·¯ç”±å®ˆå«æ›´æ–°ï¼š**
- æ£€æŸ¥ `smartfood_goal_skipped` æ ‡è®°
- å¦‚æžœå·²è·³è¿‡ï¼Œå…è®¸è®¿é—®é¦–é¡µä½†ç¦ç”¨"ç«‹åˆ»è®°å½•"æŒ‰é’®

---

## æ–°å¢žåŠŸèƒ½ï¼šå¤šè®¾å¤‡è®¿é—®æŒ‡å¼•å®Œå–„

### 1. å¤åˆ¶é“¾æŽ¥æŒ‰é’®

**UIç»„ä»¶ï¼š**
- ðŸ“‹ å¤åˆ¶æŒ‰é’®ï¼Œç´§é‚»IPåœ°å€æ˜¾ç¤º
- ä¸€é”®å¤åˆ¶å®Œæ•´URLåˆ°å‰ªè´´æ¿
- æ”¯æŒæ–°æ—§æµè§ˆå™¨çš„clipboard API

**å…³é”®ä»£ç ï¼š**

```typescript
async function copyMobileUrl() {
  const url = `http://${localIP.value}:5173`
  await navigator.clipboard.writeText(url)
  alert('é“¾æŽ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
}
```

### 2. WiFiè¿žæŽ¥æ£€æŸ¥æŒ‡å¼•

**UIç»„ä»¶ï¼š**
- å¯æŠ˜å çš„æ•…éšœæŽ’é™¤é¢æ¿
- æ£€æŸ¥æ¸…å•ï¼š
  1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘è¿žæŽ¥åŒä¸€WiFi
  2. æ£€æŸ¥é˜²ç«å¢™ç«¯å£è®¾ç½®
  3. Windowsé˜²ç«å¢™é…ç½®æŒ‡å¼•
  4. æ‰‹åŠ¨è¾“å…¥åœ°å€å°è¯•

**æ•ˆæžœï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ” æ‰‹æœºæ— æ³•è¿žæŽ¥ï¼Ÿ               â”‚
â”‚   â–¼ å±•å¼€æ£€æŸ¥æ¸…å•...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¤šIPé€‰æ‹©ç•Œé¢

**æ–°å¢žåŠŸèƒ½ï¼š**
- å½“æ£€æµ‹åˆ°å¤šä¸ªIPåœ°å€æ—¶æ˜¾ç¤ºåˆ—è¡¨
- ç”¨æˆ·å¯ç‚¹å‡»é€‰æ‹©å¯ç”¨çš„IP
- é€‰ä¸­çš„IPé«˜äº®æ˜¾ç¤º

**æ•ˆæžœï¼š**
```
æ£€æµ‹åˆ°å¤šä¸ªIPåœ°å€ï¼Œè¯·é€‰æ‹©å¯ç”¨çš„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ http://192.168.1.100:5173       â”‚ â† é€‰ä¸­
â”‚ http://192.168.0.5:5173         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®æ”¹æ–‡ä»¶æ±‡æ€»

### æ–°å¢žæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜Ž |
|----------|------|
| `backend/app/api/system.py` | ç³»ç»Ÿä¿¡æ¯APIï¼ˆlocal-ipç«¯ç‚¹ï¼‰ |
| `backend/get_local_ip.py` | IPèŽ·å–è„šæœ¬ï¼Œç”Ÿæˆip-config.json |
| `frontend/public/ip-config.json` | IPé…ç½®æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `backend/app/main.py` | æ³¨å†Œsystemè·¯ç”± |
| `backend/app/api/__init__.py` | å¯¼å‡ºsystem_router |
| `frontend/src/api/index.ts` | æ–°å¢žLocalIpResponseã€IpConfigç±»åž‹ï¼ŒgetLocalIpã€getIpFromConfigæ–¹æ³• |
| `frontend/src/views/Home.vue` | å¤šå±‚çº§IPèŽ·å–ã€å¤šIPé€‰æ‹©ã€å¤åˆ¶æŒ‰é’®ã€WiFiæŒ‡å¼• |
| `frontend/src/views/Goal.vue` | è¿›åº¦æŒ‡ç¤ºå™¨ã€è¡¨å•æŒä¹…åŒ–ã€æˆåŠŸæ¶ˆæ¯ã€è·³è¿‡é€‰é¡¹ |
| `start_local.bat` | æ–°å¢žStep 7ç”ŸæˆIPé…ç½® |
| `start_simple.bat` | æ–°å¢žIPé…ç½®ç”Ÿæˆæ­¥éª¤ |

---

## æµ‹è¯•å»ºè®®

### 1. æ‰‹æœºè®¿é—®æµç¨‹éªŒè¯

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **å¯åŠ¨åº”ç”¨**
   ```bash
   # è¿è¡Œå¯åŠ¨è„šæœ¬
   start_local.bat
   ```

2. **æ£€æŸ¥IPé…ç½®ç”Ÿæˆ**
   ```bash
   # éªŒè¯æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
   cat frontend/public/ip-config.json
   ```

3. **éªŒè¯å¤šå±‚çº§IPèŽ·å–**
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network
   - åˆ·æ–°é¦–é¡µ
   - æ£€æŸ¥ `/api/system/local-ip` è¯·æ±‚æ˜¯å¦æˆåŠŸ
   - æ£€æŸ¥ `/ip-config.json` è¯·æ±‚ï¼ˆå¦‚APIå¤±è´¥ï¼‰

4. **æ‰‹æœºè®¿é—®æµ‹è¯•**
   - ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFi
   - åœ¨æ‰‹æœºæµè§ˆå™¨è¾“å…¥æ˜¾ç¤ºçš„IPåœ°å€
   - éªŒè¯æ˜¯å¦æ­£å¸¸åŠ è½½åº”ç”¨

### 2. ç›®æ ‡è®¾ç½®æµç¨‹éªŒè¯

**æµ‹è¯•åœºæ™¯Aï¼šé¦–æ¬¡ç”¨æˆ·**

1. æ¸…é™¤localStorage
   ```javascript
   localStorage.clear()
   location.reload()
   ```

2. éªŒè¯é‡å®šå‘åˆ°ç›®æ ‡é¡µ

3. å¡«å†™éƒ¨åˆ†è¡¨å•ï¼Œåˆ·æ–°é¡µé¢
   - éªŒè¯æ•°æ®æ˜¯å¦æ¢å¤

4. å®Œæˆè®¾ç½®
   - éªŒè¯æˆåŠŸæ¶ˆæ¯æ˜¾ç¤º
   - éªŒè¯3ç§’å€’è®¡æ—¶
   - éªŒè¯è‡ªåŠ¨è·³è½¬

**æµ‹è¯•åœºæ™¯Bï¼šè·³è¿‡è®¾ç½®**

1. ç‚¹å‡»"è·³è¿‡ï¼Œç¨åŽè®¾ç½®"
2. éªŒè¯è·³è½¬åˆ°é¦–é¡µ
3. éªŒè¯"ç«‹åˆ»è®°å½•"æŒ‰é’®çŠ¶æ€

### 3. å¤šIPåœºæ™¯éªŒè¯

**æ¨¡æ‹Ÿå¤šç½‘å¡çŽ¯å¢ƒï¼š**

```javascript
// åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æ¨¡æ‹Ÿå¤šä¸ªIP
localStorage.setItem('smartfood_goal_set', 'true')
// æ‰‹åŠ¨è®¾ç½®å¤šä¸ªIPç”¨äºŽæµ‹è¯•
```

---

## æ•…éšœæŽ’é™¤

### é—®é¢˜1ï¼šåŽç«¯API IPèŽ·å–å¤±è´¥

**ç—‡çŠ¶ï¼š** `/api/system/local-ip` è¿”å›žé”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åŽç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
2. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å…è®¸8000ç«¯å£
3. æ£€æŸ¥CORSé…ç½®æ˜¯å¦åŒ…å«å‰ç«¯åœ°å€

### é—®é¢˜2ï¼šip-config.jsonæœªç”Ÿæˆ

**ç—‡çŠ¶ï¼š** é…ç½®æ–‡ä»¶ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ‰‹åŠ¨è¿è¡Œ `python backend/get_local_ip.py`
2. æ£€æŸ¥PythonçŽ¯å¢ƒå’Œä¾èµ–
3. æ£€æŸ¥æ–‡ä»¶æƒé™

### é—®é¢˜3ï¼šæ‰‹æœºæ— æ³•è®¿é—®

**ç—‡çŠ¶ï¼š** ç”µè„‘æµè§ˆå™¨æ­£å¸¸ï¼Œæ‰‹æœºæ— æ³•è®¿é—®

**æ£€æŸ¥æ¸…å•ï¼š**
1. ç¡®è®¤åŒä¸€WiFiï¼ˆæ£€æŸ¥WiFiåç§°ï¼‰
2. å…³é—­Windowsé˜²ç«å¢™æˆ–æ·»åŠ è§„åˆ™
3. ç¡®è®¤Viteå¯åŠ¨æ—¶ä½¿ç”¨ `--host 0.0.0.0`
4. å°è¯•ä½¿ç”¨ä¸åŒIPåœ°å€ï¼ˆå¦‚æœ‰å¤šIPï¼‰

### é—®é¢˜4ï¼šè¡¨å•æ•°æ®æœªä¿å­˜

**ç—‡çŠ¶ï¼š** åˆ·æ–°é¡µé¢åŽæ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸localStorage
2. æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. å°è¯•æ¸…é™¤ç¼“å­˜åŽé‡è¯•

---

## åŽç»­ä¼˜åŒ–å»ºè®®

### 1. äºŒç»´ç ç”Ÿæˆ (æ ‡æ³¨ä¸º"åŽç»­ä¼˜åŒ–")

**å®žçŽ°æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ `qrcode` åº“ç”ŸæˆäºŒç»´ç 
- åœ¨åŽç«¯APIè¿”å›žäºŒç»´ç å›¾ç‰‡
- å‰ç«¯æ˜¾ç¤ºäºŒç»´ç ä¾›æ‰‹æœºæ‰«æ

**å‚è€ƒä»£ç ï¼š**
```python
# backend/app/api/system.py
import qrcode
from io import BytesIO
import base64

@router.get("/qr-code")
async def get_qr_code():
    """ç”Ÿæˆæ‰‹æœºè®¿é—®äºŒç»´ç """
    url = f"http://{get_local_ip_addresses()[0]}:5173"
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(url)
    qr.make(fit=True)

    img = qr.make_image(fill_color="black", back_color="white")
    buffer = BytesIO()
    img.save(buffer, format='PNG')

    return {
        "qr_code": base64.b64encode(buffer.getvalue()).decode(),
        "url": url
    }
```

### 2. Toasté€šçŸ¥ä¼˜åŒ–

**å½“å‰å®žçŽ°ï¼š** ä½¿ç”¨ `alert()` æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ä½¿ç”¨è‡ªå®šä¹‰Toastç»„ä»¶
- æ”¯æŒè‡ªåŠ¨æ¶ˆå¤±
- æ”¯æŒå¤šç§æç¤ºç±»åž‹ï¼ˆæˆåŠŸ/é”™è¯¯/è­¦å‘Šï¼‰

### 3. å®žæ—¶IPæ£€æµ‹

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- WebSocketè¿žæŽ¥ç›‘å¬IPå˜åŒ–
- IPå˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æç¤º
- æ”¯æŒç½‘ç»œåˆ‡æ¢åœºæ™¯

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*ç”Ÿæˆæ—¥æœŸ: 2026-01-16*
*çŠ¶æ€: âœ… å¯åŠ¨æµç¨‹å’Œæ‰‹æœºè®¿é—®ä½“éªŒå·²ä¼˜åŒ–*
