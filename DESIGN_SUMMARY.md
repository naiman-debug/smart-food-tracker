# 智能食物记录 - 设计摘要

> GLM AI 图像识别集成设计文档
> 日期: 2026-01-16
> 版本: v1.0

---

## 一、关键设计决策

### 1.1 GLM模型选择

| 决策 | 选择 | 理由 |
|------|------|------|
| AI模型 | GLM-4.6V-Flash | 智谱AI免费视觉模型，支持中文食物识别，符合预算要求 |
| API协议 | OpenAI兼容 | Chat Completions API，易于迁移和测试 |
| 认证方式 | Bearer Token | 标准HTTP认证，通过环境变量管理 |

### 1.2 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                         前端 (Vue 3)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   首页       │  │  拍照记录    │  │  进度追踪    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            │
                    POST /api/analyze
                            │
┌─────────────────────────────────────────────────────────────┐
│                    AIService (ai_service.py)                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1. 检查 GLM_API_KEY 是否配置                         │    │
│  │  2. 调用 GLM-4.6V-Flash API 识别食物                 │    │
│  │  3. 标准化食物名称 (normalize_food_name)             │    │
│  │  4. 失败时自动降级到模拟识别                          │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
        ┌──────▼──────┐        ┌──────▼──────┐
        │  GLM API    │        │  Mock降级    │
        │  (真实AI)   │        │  (模拟识别)  │
        └─────────────┘        └─────────────┘
```

### 1.3 核心设计原则

| 原则 | 实现方式 |
|------|----------|
| **优雅降级** | API不可用时自动切换到模拟识别，保证服务可用性 |
| **向后兼容** | 新增 `ai_used` 字段，不影响现有API结构 |
| **名称标准化** | FOOD_NAME_MAPPING 将AI识别结果映射到知识库标准名称 |
| **完整日志** | 记录识别过程和降级事件，便于调试 |

### 1.4 错误处理策略

```
异常类型                  │ 处理方式
─────────────────────────┼────────────────────────
GLM_API_KEY 未配置       │ 使用模拟识别，ai_used=false
网络超时/连接失败         │ 使用模拟识别，ai_used=false
401 密钥无效             │ 使用模拟识别，记录错误日志
429 请求频率超限         │ 使用模拟识别，建议稍后重试
500+ 服务端错误           │ 使用模拟识别，ai_used=false
食物不在知识库 (404)      │ 返回可用食物列表供调试
```

---

## 二、与PRD的对应关系

### 2.1 功能对照表

| PRD需求 | 实现状态 | 技术方案 |
|---------|----------|----------|
| **拍照记录，零手动输入** | ✅ 已实现 | POST /api/analyze 调用GLM识别食物 |
| **AI自动识别食物** | ✅ 已实现 | GLM-4.6V-Flash视觉模型 |
| **专属视觉份量选择** | ✅ 已实现 | VisualPortion表存储份量描述 |
| **首页清晰掌控今日余额** | ✅ 已实现 | GET /api/balance 返回剩余额度 |
| **智能建议快捷加餐** | ⚠️ 待实现 | 需要根据余额计算推荐食物 |
| **进度追踪，关注缺口** | ✅ 已实现 | GET /api/progress 返回累计缺口 |
| **目标设置** | ✅ 已实现 | POST /api/goals 计算BMR和TDEE |

### 2.2 用户体验流程对比

**PRD期望流程:**
```
拍照 → AI识别 → 选择份量 → 确认记录 → 自动更新今日余额
```

**实际实现:**
```
前端拍照 → POST /api/analyze (GLM识别) → 返回份量选项
→ 前端显示份量选择 → 用户选择 → POST /api/records (保存记录)
→ GET /api/balance (获取更新后的余额)
```

### 2.3 视觉份量描述示例

| 食物类型 | PRD描述 | 数据库实现 |
|----------|---------|------------|
| 肉类 | "掌心大小"、"信用卡厚度" | `portion_name: "掌心大小（正常厚度，约120g）"` |
| 水果 | "网球大小"、"拳头大小" | `portion_name: "拳头大小（正常，约150g）"` |
| 蔬菜 | "双手一捧" | `portion_name: "双手一捧（约80g）"` |
| 主食 | "一小碗"、"一碗半" | `portion_name: "一小碗（约150g）"` |

---

## 三、技术实现细节

### 3.1 API端点设计

| 端点 | 方法 | 功能 | GLM集成 |
|------|------|------|---------|
| /api/analyze | POST | 分析食物图片 | ✅ 核心集成点 |
| /api/records | POST | 创建饮食记录 | ❌ 使用已有份量数据 |
| /api/balance | GET | 获取今日余额 | ❌ 纯数据库查询 |
| /api/progress | GET | 获取进度统计 | ❌ 纯数据库计算 |
| /api/goals | POST | 设置每日目标 | ❌ BMR/TDEE计算 |

### 3.2 数据流程

```
用户上传图片 (base64)
        │
        ▼
┌───────────────────────────────────────────┐
│ POST /api/analyze                         │
│ { "image_base64": "..." }                 │
└───────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────┐
│ AIService.analyze_image()                 │
│ ├─ 检查 GLM_API_KEY                       │
│ ├─ 调用 GLM API (analyze_image_with_glm)  │
│ ├─ 标准化名称 (normalize_food_name)       │
│ └─ 失败时降级 (mock_analyze_image)        │
└───────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────┐
│ 返回响应                                   │
│ {                                         │
│   "food_name": "鸡胸肉",                   │
│   "portion_options": [...],               │
│   "ai_used": true                         │
│ }                                         │
└───────────────────────────────────────────┘
```

### 3.3 核心代码结构

```
backend/
├── app/
│   ├── services/
│   │   └── ai_service.py        # AI识别服务 (GLM集成)
│   ├── api/
│   │   └── meal.py              # 饮食记录API
│   └── models/
│       ├── visual_portion.py    # 视觉份量模型
│       ├── meal_record.py       # 饮食记录模型
│       └── daily_goal.py        # 每日目标模型
├── requirements.txt             # httpx依赖
└── .env                         # GLM_API_KEY配置
```

---

## 四、需要审核的设计疑问

### 4.1 待确认问题

| 问题编号 | 问题描述 | 影响 | 建议方案 |
|----------|----------|------|----------|
| Q-001 | GLM API免费版配额限制 | 高并发时可能触发429限流 | 实现30秒延迟重试机制 |
| Q-002 | 食物知识库仅18种 | 识别出不在库的食物会返回404 | 定期扩展食物库或允许用户添加 |
| Q-003 | 单次识别仅返回1种食物 | 复杂餐盘（多菜一汤）识别不准 | 考虑支持多食物识别 |
| Q-004 | 智能建议功能未实现 | PRD中的"可以吃这些"功能缺失 | 根据余额自动推荐份量合适的食物 |
| Q-005 | 模拟识别结果随机 | 降级时用户体验不一致 | 使用历史记录进行智能推荐 |

### 4.2 性能考量

| 指标 | 当前值 | 优化建议 |
|------|--------|----------|
| GLM API响应时间 | 2-5秒 | 考虑异步处理，前端显示loading |
| 降级响应时间 | <100ms | 已优化，无需改动 |
| 识别准确率 | 待实测 | 收集真实数据后优化prompt |
| 并发支持 | 受限于GLM配额 | 监控用量，考虑升级付费版 |

### 4.3 安全性考虑

| 风险 | 当前措施 | 建议 |
|------|----------|------|
| API密钥泄露 | .env文件在.gitignore中 | 定期轮换密钥 |
| 图片大小限制 | 无限制 | 添加图片大小验证（建议<5MB） |
| 恶意请求 | 无限流 | 实现用户级请求频率限制 |

---

## 五、测试与验证

### 5.1 测试覆盖

| 测试类型 | 状态 | 备注 |
|----------|------|------|
| API密钥验证 | ✅ 通过 | PowerShell测试脚本 |
| 文本识别测试 | ✅ 通过 | 返回"Connection OK" |
| 图像识别测试 | ✅ 通过 | GLM API调用成功 |
| 名称映射功能 | ✅ 代码实现 | 待真实图片验证 |
| 错误处理测试 | ✅ 代码实现 | 待异常场景验证 |
| 降级机制测试 | ✅ 代码实现 | 待断网场景验证 |

### 5.2 测试密钥信息

```
API Key: 7ce400cc79454af49b6fd62ebc69e7ab.LiscGibdoY1Dzp4z
Model: glm-4.6v-flash (免费版)
状态: ✅ 有效
测试日期: 2026-01-16
```

---

## 六、部署清单

### 6.1 环境变量配置

```bash
# backend/.env
GLM_API_KEY=your_api_key_here
```

### 6.2 依赖安装

```bash
pip install -r requirements.txt
# 关键依赖: httpx>=0.25.0
```

### 6.3 启动命令

```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 七、后续优化方向

### 7.1 短期优化 (1-2周)

- [ ] 实现智能建议功能（根据余额推荐食物）
- [ ] 扩展食物知识库到30+种
- [ ] 添加图片大小验证
- [ ] 实现请求频率限制

### 7.2 中期优化 (1-2月)

- [ ] 支持多食物识别（一餐多菜）
- [ ] 实现识别结果缓存
- [ ] 添加用户自定义食物功能
- [ ] 优化GLM prompt提高准确率

### 7.3 长期优化 (3-6月)

- [ ] 迁移到付费GLM模型（更高准确率）
- [ ] 实现自动重试机制
- [ ] 添加识别统计和分析
- [ ] 支持食物热量自定义

---

## 八、相关文档

| 文档 | 路径 |
|------|------|
| 产品需求文档 | [PRD_DRAFT_FOR_REVIEW.md](./PRD_DRAFT_FOR_REVIEW.md) |
| GLM集成日志 | [GLM_INTEGRATION_LOG.md](./GLM_INTEGRATION_LOG.md) |
| GLM配置指南 | [backend/GLM_CONFIG.md](./backend/GLM_CONFIG.md) |
| 测试指南 | [GLM_TEST_GUIDE.md](./GLM_TEST_GUIDE.md) |
| 后端代码摘要 | [backend_code_summary.txt](./backend_code_summary.txt) |

---

*文档版本: v1.0*
*最后更新: 2026-01-16*
*维护者: Claude*
